# Merge Dependabot PRs - Manual trigger only
# Run from Actions tab when you want to merge all open Dependabot PRs sequentially
name: Merge Dependabot PRs

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-dependabot:
    name: Merge Dependabot PRs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge Dependabot PRs sequentially
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get open Dependabot PRs only (--app dependabot = official Dependabot GitHub App)
          PRS=$(gh pr list --app dependabot --state open --json number,title --jq 'sort_by(.number) | .[].number')
          
          if [ -z "$PRS" ]; then
            echo "No open Dependabot PRs found."
            exit 0
          fi
          
          echo "Found Dependabot PRs to merge:"
          echo "$PRS"
          
          for PR in $PRS; do
            echo ""
            echo "Merging PR #$PR..."
            if ! gh pr merge "$PR" --squash --delete-branch; then
              echo "Failed to merge PR #$PR (may need checks to pass or manual review)"
              echo "Leaving PR #$PR open."
              continue
            fi
            echo "Merged PR #$PR"
          done
          
          echo ""
          echo "Finished processing Dependabot PRs (merged where possible)."
